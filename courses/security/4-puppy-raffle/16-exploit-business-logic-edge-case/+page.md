---
title: Exploit - Business Logic Edge Case
---

_Follow along with this video:_

## 

---

# A Deep Dive Into the 'PuppyRaffle’ Contract

Hey there! Today, we'll unwrap the layers of the `PuppyRaffle` contract. We’ll conduct a detailed analysis identifying how the contract works, pinpointing possible issues and areas of concern, and discuss how we can improve it.

## Understanding the Enter Raffle

We’ve found some interesting pieces of code that we think should be analyzed. The crucial operation, as it appears, revolves around the `players` array. The ‘Enter Raffle’ logic seems to store value in this array, and it gets updated with new entries – jot that down for a later review.

![](https://cdn.videotap.com/UXaQJF1HNUDQ9qWrwwvD-21.57.png)As we go through this, we might have some questions. One in particular is: **"What resets the `players` array?"** – a point we’ll come back to later.

## Examining the Refund Function

The next essential function we’re interested in is the `refund` function. According to the `README` file, this function allows users to claim a refund of their ticket value.

![](https://cdn.videotap.com/pdFQ3caBtnyX6H3J3nNf-43.14.png)

```js
function refund(player_index){...}
```

This function requires a `player_index`, obviously referring to the index of the player in the `players` array. The question then becomes, how do we obtain this index?

## The GetActivePlayerIndex Function

Delving into the contract, we find the answer in the `GetActivePlayerIndex` function:

```js
function getActivePlayerIndex(player_address){...}
```

This function, given an address of a player, returns the corresponding index. Although it seems straightforward, there might be a potential flaw here, and this is where our Spidey-sense starts tingling.

![](https://cdn.videotap.com/pqfJnRhCJl6hQKNlJck4-102.46.png)If a player is not present, this function defaults to returning zero. The issue, however, arises if there’s an active player at index zero.

> **Possible Attack Vector:** If the player is at index zero, the system might mistake it as the player not being active!

This is absolutely a flaw that must be highlighted in our audit report.

We might just have discovered a significant bug affecting the `GetActivePlayerIndex` function. Specific as it may be, this finding indicates the need for thorough analysis of any smart contract – regardless of its perceived simplicity.

To wrap this up, it’s clear that the `PuppyRaffle` contract, just like any smart contract, harbors its own unique intricacies and possible vulnerabilities. With a methodical approach, we can uncover these issues, ask the right questions, and improve the system's overall quality and security.

Thank you for following along this deep-dive. Stay tuned for further examinations as we continue to unmask more bugs and features in future posts.
